<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · Dispersal.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Dispersal.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Setup"><span>Setup</span></a></li><li><a class="tocitem" href="#Output"><span>Output</span></a></li><li><a class="tocitem" href="#Live-simulation-outputs"><span>Live simulation outputs</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/cesaraustralia/Dispersal.jl/blob/master/docs/src/example.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><hr/><p>author: &quot;Rafael Schouten&quot; title: &quot;Dispersal.jl example&quot; –-</p><h1 id="Dispersal-simulations"><a class="docs-heading-anchor" href="#Dispersal-simulations">Dispersal simulations</a><a id="Dispersal-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Dispersal-simulations" title="Permalink"></a></h1><p>In this example we will run a simulation of the spread of an invasive insect  accross Australia, after an incursion in Brisbane.</p><h2 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h2><p>First, load the required packages. Dates is a core julia package that give us  date/time handling, GeoData and RasterDataSources simplify the loading of geospatial raster files. It requires also loading NCDatasets.jl and ArchGDAL.jl to load NetCDF and GeoTiff files, respectively.</p><pre><code class="language-julia hljs">using DynamicGrids
using GeoData, NCDatasets, ArchGDAL, RasterDataSources
using Dispersal, Dates, Plots, GrowthMaps, Unitful, Statistics
using Unitful: °C, K, cal, mol, mm
basedir = realpath(joinpath(dirname(Base.pathof(Dispersal)), &quot;../docs&quot;))</code></pre><h3 id="Define-simulation-extent-in-space-and-time:"><a class="docs-heading-anchor" href="#Define-simulation-extent-in-space-and-time:">Define simulation extent in space and time:</a><a id="Define-simulation-extent-in-space-and-time:-1"></a><a class="docs-heading-anchor-permalink" href="#Define-simulation-extent-in-space-and-time:" title="Permalink"></a></h3><p>We use <code>DateTime</code> of for the time dimension:</p><pre><code class="language-julia hljs">timestep = Month(1);
tspan = DateTime(2022, 1):timestep:DateTime(2030, 12)
aust = Lon(Between(113, 154)),
       Lat(Between(-45, -10));</code></pre><hr/><h3 id="Define-a-RuleSet:-climate-driven-population-growth"><a class="docs-heading-anchor" href="#Define-a-RuleSet:-climate-driven-population-growth">Define a <code>RuleSet</code>: climate driven population growth</a><a id="Define-a-RuleSet:-climate-driven-population-growth-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-RuleSet:-climate-driven-population-growth" title="Permalink"></a></h3><p>This will involve combining multiple dispersal components into a single <code>RuleSet</code> object: population growth, local dispersal, Allee effects, and human dispersal.</p><h3 id="Local-dispersal"><a class="docs-heading-anchor" href="#Local-dispersal">Local dispersal</a><a id="Local-dispersal-1"></a><a class="docs-heading-anchor-permalink" href="#Local-dispersal" title="Permalink"></a></h3><pre><code class="language-julia hljs">localdisp = InwardsDispersal(;
    radius=1,
    formulation=ExponentialKernel(; λ = 0.0125),
    distancemethod=AreaToArea(30),
)</code></pre><h3 id="Allee-effects"><a class="docs-heading-anchor" href="#Allee-effects">Allee effects</a><a id="Allee-effects-1"></a><a class="docs-heading-anchor-permalink" href="#Allee-effects" title="Permalink"></a></h3><pre><code class="language-julia hljs">allee = AlleeExtinction(; minfounders=10.0);</code></pre><h3 id="Human-dispersal"><a class="docs-heading-anchor" href="#Human-dispersal">Human dispersal</a><a id="Human-dispersal-1"></a><a class="docs-heading-anchor-permalink" href="#Human-dispersal" title="Permalink"></a></h3><p>The human dispersal component is generated from an array or population data. First we&#39;ll open an input tiff, and move it to a memory backed <code>GeoArray</code>.</p><pre><code class="language-julia hljs">humanpop_url = &quot;https://github.com/cesaraustralia/DSuzukiiInvasionPaper/blob/master/data/population_density.tif?raw=true&quot;
humanpop_filename = &quot;population_density.tif&quot;
humanpop_filepath = joinpath(basedir, humanpop_filename)
isfile(humanpop_filepath) || download(humanpop_url, humanpop_filepath);</code></pre><p>Again select the Australian bounds. This time we also select the first Band. Tiff data always has bands, even when there is only one:</p><pre><code class="language-julia hljs">humanpop = GDALarray(humanpop_filepath; mappedcrs=EPSG(4326))[Band(1), aust...] |&gt;
    A -&gt; replace_missing(A, missing) |&gt;
    A -&gt; permutedims(A, (Lat, Lon)) |&gt; 
    A -&gt; reorder(A, Lat=ReverseArray, Lon=ForwardArray)
plot(humanpop)
savefig(joinpath(basedir, &quot;build/assets/humanpop.png&quot;));</code></pre><p><img src="assets/humanpop.png" alt="popgrowth"/></p><pre><code class="language-julia hljs">humandisp = HumanDispersal(
    human_pop=parent(humanpop),
    human_exponent=2.0,
    dist_exponent=2.0,
    dispersalperpop=1e-9,
    max_dispersers=500.0,
    nshortlisted=50,
    scale=8,
);</code></pre><p>To obtain spatially and temporally heterogeneous growth rates for our growth model, we simplify the <a href="https://rafaqz.github.io/GrowthRates.jl/dev/example/index.html">examples tutorial</a>  over at <a href="https://github.com/rafaqz/GrowthRates.jl">GrowthRates.jl</a>.</p><pre><code class="language-julia hljs"># Generate a growth response curve
p = 3.626804f-01
ΔH_A = 3.586625f4cal/mol
ΔH_H = 1.431237f5cal/mol
Thalf_H = 2.988454f2K
ΔH_L = -1.108988f5cal/mol
Thalf_L = 2.459949f2K
T_ref = K(25.0f0°C)
growthresponse = Layer(:tavg, °C,
    SchoolfieldIntrinsicGrowth(p, ΔH_A, ΔH_L, Thalf_L, ΔH_H, Thalf_H, T_ref)
)
# Add some lower and upper temperature bounds that cause mortality
coldthresh = -10.0f0°C |&gt; K
coldmort = -log(1.23f0)K^-1
heatthresh = 30.0f0°C |&gt; K
heatmort = -log(1.15f0)K^-1
coldstress = Layer(:tavg, °C, LowerStress(coldthresh, coldmort))
heatstress = Layer(:tavg, °C, UpperStress(heatthresh, heatmort))
# Set a stressor based on precipitation - there are better data to use
# for this, but this is easy to download for the example
wetthresh = 40mm
wetmort = -0.01f0mm^-1
wetstress = Layer(:prec, mm, LowerStress(wetthresh, wetmort))
# Define the whole model
model = growthresponse, coldstress, heatstress, wetstress

# Download some climate data, and reseample to match the population data
ser = map(series(WorldClim{Climate}, (:tavg, :prec); month=1:12)) do stack
    map(A -&gt; resample(A, humanpop), stack)
end;
growthrates = mapgrowth(model; series=ser, tspan=1:12)</code></pre><p>Plot the growth layer:</p><pre><code class="language-julia hljs">mode_ = Projected(; crs=crs(growthrates), mappedcrs=EPSG(4326))
growthrates = set(growthrates[Band(1)], Lat=mode_, Lon=mode_) |&gt;
    A -&gt; set(A, Ti(DateTime(2017, 1):Month(1):DateTime(2017, 12))) |&gt;
    A -&gt; permutedims(A, (Lat, Lon, Ti)) |&gt;
    A -&gt; reorder(A, Lat=ReverseArray, Lon=ForwardArray)
plot(growthrates[Ti(5)]; clims=(0, 0.1))
Plots.savefig(joinpath(basedir, &quot;build/assets/growthrates.png&quot;));</code></pre><p><img src="assets/growthrates.png" alt="popgrowth"/></p><p>Create a <code>ExactLogisticGrowthMap</code> rule from the layer, here we use unitful units for the layers&#39; time dimension:</p><pre><code class="language-julia hljs">carrycap = 1e9
growth = LogisticGrowth(; rate=Aux(:growthrates), timestep=Day(1), carrycap=carrycap);</code></pre><h3 id="Define-initialisation-data"><a class="docs-heading-anchor" href="#Define-initialisation-data">Define initialisation data</a><a id="Define-initialisation-data-1"></a><a class="docs-heading-anchor-permalink" href="#Define-initialisation-data" title="Permalink"></a></h3><p>Make a zeros <code>GeoArray</code>. We need to replace the <code>missing</code> values, as init can&#39;t contain <code>missing</code> or it will spread everywhere. We then initialise a population in Brisbane:</p><pre><code class="language-julia hljs">init = replace_missing(humanpop, NaN) |&gt; zero
lat, lon = -27.5, 153 # Brisbane
init[Lat(Contains(lat)), Lon(Contains(lon))] = carrycap</code></pre><h3 id="Define-a-masking-layer"><a class="docs-heading-anchor" href="#Define-a-masking-layer">Define a masking layer</a><a id="Define-a-masking-layer-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-masking-layer" title="Permalink"></a></h3><p>This layer lets the simulation know which cells should be ignored.</p><pre><code class="language-julia hljs">masklayer = boolmask(growthrates[Ti(1)])
plot(masklayer)
savefig(joinpath(basedir, &quot;build/assets/mask.png&quot;));</code></pre><p><img src="assets/mask.png" alt="mask"/></p><h3 id="Define-a-combined-ruleset"><a class="docs-heading-anchor" href="#Define-a-combined-ruleset">Define a combined ruleset</a><a id="Define-a-combined-ruleset-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-combined-ruleset" title="Permalink"></a></h3><pre><code class="language-julia hljs">ruleset = Ruleset(humandisp, localdisp, allee, growth; timestep=timestep)</code></pre><hr/><h2 id="Output"><a class="docs-heading-anchor" href="#Output">Output</a><a id="Output-1"></a><a class="docs-heading-anchor-permalink" href="#Output" title="Permalink"></a></h2><p>Outputs hold all spatial and temporal information about the simulation, as these match the size and length of the output, making the <code>Ruleset</code> independent of location and time. <code>init</code>, <code>tspan</code>, <code>aux</code> and <code>mask</code> are common to all outputs, here we use the masklayer for <code>mask</code> and growthrates for <code>aux</code>.</p><p>Gif files are an easy way to share the visual dynamics of the simulation. <code>GifOutput</code> saves a gif when the simulation finishes.</p><p>You can use the built-in <code>Greyscale</code> scheme or any scheme from <a href="https://github.com/JuliaGraphics/ColorSchemes.jl">ColorSchemes.jl</a>. </p><pre><code class="language-julia hljs">using ColorSchemes
output = GifOutput(init;
    # Core keywords
    tspan=tspan,
    mask=masklayer,
    aux=(growthrates=growthrates,),
    # Visualisation keywords
    scheme=ColorSchemes.tokyo, fps=10,
    minval=0.0, maxval=carrycap, 
    filename=joinpath(basedir, &quot;build/assets/sim.gif&quot;),
);</code></pre><h3 id="Run-a-simulation-and-save-a-gif"><a class="docs-heading-anchor" href="#Run-a-simulation-and-save-a-gif">Run a simulation and save a gif</a><a id="Run-a-simulation-and-save-a-gif-1"></a><a class="docs-heading-anchor-permalink" href="#Run-a-simulation-and-save-a-gif" title="Permalink"></a></h3><p>To run a simulation, we pass in the output and rulset.</p><pre><code class="language-julia hljs">sim!(output, ruleset);</code></pre><p><img src="assets/sim.gif" alt="Drosphila suzukii spread"/></p><h2 id="Live-simulation-outputs"><a class="docs-heading-anchor" href="#Live-simulation-outputs">Live simulation outputs</a><a id="Live-simulation-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Live-simulation-outputs" title="Permalink"></a></h2><p>There are a number of live outputs provided in DynamicGrids.jl and specific output packages DynamicGridsGtk and DynamicGridsInteract that keep heavy graphics and web dependencies separate form the rest of the framework.</p><h3 id="REPL-output"><a class="docs-heading-anchor" href="#REPL-output">REPL output</a><a id="REPL-output-1"></a><a class="docs-heading-anchor-permalink" href="#REPL-output" title="Permalink"></a></h3><p>You can view a simulation over SSH or just in your local console using the included <code>REPLOutput</code>. It doesn&#39;t work so well in Atom/Juno, so we only recommend using it in a real terminal. It also works better in a terminal where you can easily reduce the font size.</p><pre><code class="language-julia hljs">using Crayons
output = REPLOutput(init; 
    mask=masklayer, 
    aux=(growthrates=growthrates,), 
    tspan=tspan, 
    style=Block(), fps=5, color=:white, store=false
)
sim!(output, ruleset);</code></pre><p>The <code>Braile()</code> style uses half the space of the <code>Block()</code> style, but won&#39;t look as clear.</p><h3 id="Interactive-web-outputs"><a class="docs-heading-anchor" href="#Interactive-web-outputs">Interactive web outputs</a><a id="Interactive-web-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Interactive-web-outputs" title="Permalink"></a></h3><p><a href="http://gihub.com/rafaqz/DynamicGridsInteract.jl">DynamicGridsInteract.jl</a> produces interactive web page outputs for a simulation. It uses Interact.jl for live control, providing a control console and sliders for model parameters, even for your own custom models.</p><p>The simple <code>InteractOutput()</code> is the core output that can run on its own inside Juno or a Jupyter notebook. It can also be served to a browser locally or over the web using <code>ServerOutput()</code>, or run in a standalone desktop app using <code>ElectronOutput()</code>.</p><h3 id="Juno-or-jupyter-notebooks"><a class="docs-heading-anchor" href="#Juno-or-jupyter-notebooks">Juno or jupyter notebooks</a><a id="Juno-or-jupyter-notebooks-1"></a><a class="docs-heading-anchor-permalink" href="#Juno-or-jupyter-notebooks" title="Permalink"></a></h3><p>Building a <code>InteractOutput()</code> and running <code>display()</code> will open an output in a plot pane in Juno. See the example above to define an image processor. Setting <code>store</code> to true will save the last simulation to the output array to be saved or converted to a gif. Really long simulations may use your avilable ram, in which case set <code>store</code> to false.</p><pre><code class="language-julia hljs">using DynamicGridsInteract
output = InteractOutput(init;
    ruleset=ruleset,
    tspan=tspan, mask=masklayer, aux=(growthrates=growthrates,),
    fps=10, store=true, scheme=ColorSchemes.tokyo, 
    minval=0.0, maxval=carrycap,
    slider_throttle=0.5,
)
display(output)</code></pre><h3 id="Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app"><a class="docs-heading-anchor" href="#Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app">Wrap the IneractOutput in a standalone desktop (electron) app</a><a id="Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app-1"></a><a class="docs-heading-anchor-permalink" href="#Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app" title="Permalink"></a></h3><p>This will create a standalone desktop app wrapping the InteractOutput. Unfortunately the compile and load time for electron can take quite a while.</p><pre><code class="language-julia hljs">output = ElectronOutput(init;
    ruleset=ruleset,
    tspan=tspan, mask=masklayer, aux=(growthrates=growthrates,),
    fps=10, store=true, scheme=ColorSchemes.tokyo, 
    minval=0.0, maxval=carrycap,
    slider_throttle=1.0,
)</code></pre><h3 id="Serving-web-pages"><a class="docs-heading-anchor" href="#Serving-web-pages">Serving web pages</a><a id="Serving-web-pages-1"></a><a class="docs-heading-anchor-permalink" href="#Serving-web-pages" title="Permalink"></a></h3><p>The <code>InteractOutput</code> can be served locally or over the web. You may need to do some port or firewall configuration on your server, but otherwise this is all you need to do to serve a simulation. Unlike other outputs, <code>ServerOutput</code> makes a copy of the internal <code>InteractOutput</code> for each new connection. Changes in one connection will not effect anything in the others. It tends to flash in Firefox, Chrome may be a better option.</p><pre><code class="language-julia hljs">output = ServerOutput(init;
    ruleset=ruleset,
    tspan=tspan, mask=masklayer, aux=(growthrates=growthrates,),
    fps=10, store=true, scheme=ColorSchemes.tokyo, 
    minval=0.0, maxval=carrycap,
    slider_throttle=1.0,
    port=8080,
)</code></pre><h3 id="Run-in-a-GTK-window"><a class="docs-heading-anchor" href="#Run-in-a-GTK-window">Run in a GTK window</a><a id="Run-in-a-GTK-window-1"></a><a class="docs-heading-anchor-permalink" href="#Run-in-a-GTK-window" title="Permalink"></a></h3><p>The <code>GTKOutput</code> in <a href="http://gihub.com/rafaqz/DynamicGridsGtk.jl">DynamicGridsGtk.jl</a> is a simple desktop output that just shows the simulation without controls. It can be useful for faster load-time than <code>ElectronOutput</code>, and also dedicates all screenspace to viewing the simulation.</p><pre><code class="language-julia hljs">using DynamicGridsGtk
output = GtkOutput(init;
    mask=masklayer, aux=(growthrates=growthrates,), tspan=tspan,
    fps=10, store=true, scheme=ColorSchemes.tokyo, 
    minval=0.0, maxval=carrycap,
)
sim!(output, ruleset)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Monday 6 December 2021 13:10">Monday 6 December 2021</span>. Using Julia version 1.6.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
