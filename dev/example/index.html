<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · Dispersal.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Dispersal.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Setup"><span>Setup</span></a></li><li><a class="tocitem" href="#Output"><span>Output</span></a></li><li><a class="tocitem" href="#Live-simulation-outputs"><span>Live simulation outputs</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/cesaraustralia/Dispersal.jl/blob/master/docs/src/example.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><hr/><p>author: &quot;Rafael Schouten&quot; title: &quot;Dispersal.jl example&quot; –-</p><h1 id="Dispersal-simulations"><a class="docs-heading-anchor" href="#Dispersal-simulations">Dispersal simulations</a><a id="Dispersal-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Dispersal-simulations" title="Permalink"></a></h1><p>In this example we will run a simulation of the spread of the Spotted Winged Drosophila <em>D. suzukii</em> accross the continental USA.</p><h2 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h2><p>First, load the required packages. Dates is a core julia package that give us date/time handling, GeoData simplifies the loading of geospatial raster files. It requires also loading NCDatasets.jl and ArchGDAL.jl to load NetCDF and GeoTiff files, respectively.</p><pre><code class="language-julia"># using Pkg
# Pkg.add(PackageSpec(url=&quot;https://github.com/rafaqz/GeoData.jl&quot;, rev=&quot;master&quot;))

using GeoData, DimensionalData, Dispersal, Dates, NCDatasets, ArchGDAL, Plots
using DimensionalData: rebuild, Forward, Reverse
basedir = joinpath(dirname(Base.pathof(Dispersal)), &quot;../docs&quot;)</code></pre><h3 id="Define-simulation-extent-in-space-and-time:"><a class="docs-heading-anchor" href="#Define-simulation-extent-in-space-and-time:">Define simulation extent in space and time:</a><a id="Define-simulation-extent-in-space-and-time:-1"></a><a class="docs-heading-anchor-permalink" href="#Define-simulation-extent-in-space-and-time:" title="Permalink"></a></h3><p>We use <code>DateTime</code> of for the time dimension:</p><pre><code class="language-julia">timestep = Month(1);
tspan = DateTime(2016, 1):Month(1):DateTime(2018, 12)
aust = Lon(Between(113.338953078, 153.569469029)),
       Lat(Between(-43.6345972634, -10.6681857235));</code></pre><hr/><h3 id="Define-a-RuleSet:-climate-driven-population-growth"><a class="docs-heading-anchor" href="#Define-a-RuleSet:-climate-driven-population-growth">Define a <code>RuleSet</code>: climate driven population growth</a><a id="Define-a-RuleSet:-climate-driven-population-growth-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-RuleSet:-climate-driven-population-growth" title="Permalink"></a></h3><p>This will involve combining multiple dispersal components into a single <code>RuleSet</code> object: population growth, local dispersal, Allee effects, and human dispersal.</p><p>Follow the <a href="https://rafaqz.github.io/GrowthRates.jl/dev/example/index.html">examples tutorial</a> over at <a href="https://github.com/rafaqz/GrowthRates.jl">GrowthRates.jl</a>. To skip this step just download the output saved in the example:</p><pre><code class="language-julia">dataurl = &quot;https://media.githubusercontent.com/media/cesaraustralia/Dispersal.jl/data&quot;
growthratesfilename = &quot;growthrates.ncd&quot;
growthratesfilepath = joinpath(basedir, growthratesfilename)
isfile(growthratesfilepath) ||
  download(joinpath(dataurl, growthratesfilename), joinpath(basedir, growthratesfilename));</code></pre><p>And select just the bounding box for Australia, and set the dimension order to Lat/Lon:</p><pre><code class="language-julia">growthrates = NCDarray(growthratesfilepath)
# Set the length of the timestep. TODO: get this automatically from NetCDF units in GeoData.jl
mode_ = Sampled(DimensionalData.order(ti), Regular(timestep), Intervals(Start()))
growthrates = set(growthrates, Ti=mode_);</code></pre><p>Plot the growth layer:</p><pre><code class="language-julia">growthrates[Ti(1)] |&gt; plot
savefig(joinpath(basedir, &quot;build/assets/growthrates.png&quot;));</code></pre><p>Create a <code>ExactLogisticGrowthMap</code> rule from the layer, here we use unitful units for the layers&#39; time dimension:</p><pre><code class="language-julia">carrycap = 1e9
growth = ExactLogisticGrowthMap(layerkey=:growthrates, carrycap=carrycap);</code></pre><h3 id="Local-dispersal"><a class="docs-heading-anchor" href="#Local-dispersal">Local dispersal</a><a id="Local-dispersal-1"></a><a class="docs-heading-anchor-permalink" href="#Local-dispersal" title="Permalink"></a></h3><pre><code class="language-julia">λ = 0.0125
radius = 1
sze = 2radius + 1
dm = AreaToArea(30)
@time hood = DispersalKernel{radius}(;
    kernel=zeros(Float64, radius, radius),
    formulation=ExponentialKernel(λ),
    distancemethod=dm
)
localdisp = InwardsPopulationDispersal(hood);</code></pre><h3 id="Allee-effects"><a class="docs-heading-anchor" href="#Allee-effects">Allee effects</a><a id="Allee-effects-1"></a><a class="docs-heading-anchor-permalink" href="#Allee-effects" title="Permalink"></a></h3><pre><code class="language-julia">allee = AlleeExtinction(minfounders=10.0);</code></pre><h3 id="Human-dispersal"><a class="docs-heading-anchor" href="#Human-dispersal">Human dispersal</a><a id="Human-dispersal-1"></a><a class="docs-heading-anchor-permalink" href="#Human-dispersal" title="Permalink"></a></h3><p>The human dispersal component is generated from an array or population data. First we&#39;ll open an input tiff, and move it to a memory backed <code>GeoArray</code>.</p><pre><code class="language-julia">humanpop_filename = &quot;population_density.tif&quot;
humanpop_filepath = joinpath(basedir, humanpop_filename)
isfile(humanpop_filepath) || download(joinpath(dataurl, humanpop_filename), humanpop_filepath);</code></pre><p>Again select the Australian bounds. This time we also select the first Band. Tiff data always has bands, even when there is only one:</p><pre><code class="language-julia">humanpop = GDALarray(humanpop_filepath; usercrs=EPSG(4326))[Band(1), aust...] |&gt;
    A -&gt; permutedims(A, (Lat, Lon)) |&gt; reorderarray
savefig(joinpath(basedir, &quot;build/assets/humanpop.png&quot;));</code></pre><p><img src="assets/humanpop.png" alt="popgrowth"/></p><pre><code class="language-julia">@time humandisp = HumanDispersal(
    human_pop=parent(humanpop),
    human_exponent=2.0,
    dist_exponent=2.0,
    dispersalperpop=1e-9,
    max_dispersers=500.0,
    nshortlisted=50,
    scale=8,
);</code></pre><h3 id="Define-initialisation-data"><a class="docs-heading-anchor" href="#Define-initialisation-data">Define initialisation data</a><a id="Define-initialisation-data-1"></a><a class="docs-heading-anchor-permalink" href="#Define-initialisation-data" title="Permalink"></a></h3><p>Make a zeros array and populate the starting cells. We need to replace the <code>missing</code> values with something else Dispersal.jl init can&#39;t contain <code>missing</code> or it will spread everywhere:</p><pre><code class="language-julia">init = replace_missing(growthrates[Ti(1)], NaN) |&gt; zero
incursion = [(36.9677, -122.0294),
             (37.3226, -121.8921),
             (37.6008, -120.9545),
             (35.3453, -119.0586),
             (38.7318, -121.9014),
             (38.5249, -121.9708),
             (37.2502, -119.751)]
# Using `Contains` finds the interval that contains the coordinates
for (lat, lon) in incursion
    init[Lat(Contains(lat)), Lon(Contains(lon))] = 1e7
end</code></pre><h3 id="Define-a-masking-layer"><a class="docs-heading-anchor" href="#Define-a-masking-layer">Define a masking layer</a><a id="Define-a-masking-layer-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-masking-layer" title="Permalink"></a></h3><p>This layer lets the simulation know which cells should be ignored.</p><pre><code class="language-julia">masklayer = boolmask(growthrates[Ti(1)])
plot(masklayer)
savefig(joinpath(basedir, &quot;build/assets/mask.png&quot;));</code></pre><p><img src="assets/mask.png" alt="mask"/></p><h3 id="Define-a-combined-ruleset"><a class="docs-heading-anchor" href="#Define-a-combined-ruleset">Define a combined ruleset</a><a id="Define-a-combined-ruleset-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-combined-ruleset" title="Permalink"></a></h3><pre><code class="language-julia">ruleset = Ruleset(
    humandisp, Chain(localdisp, allee, growth);
    timestep=timestep,
);</code></pre><hr/><h2 id="Output"><a class="docs-heading-anchor" href="#Output">Output</a><a id="Output-1"></a><a class="docs-heading-anchor-permalink" href="#Output" title="Permalink"></a></h2><p>The simplest and oftern the most performant output for a simulation is an ArrayOutput, which simply writes the simulation to a preallocated array without visualising it.</p><pre><code class="language-julia">output = ArrayOutput(init;
    tspan=tspan,
    mask=masklayer,
    aux=(growthrates=growthrates,),
    minval=0.0,
    maxval=carrycap,
);</code></pre><h3 id="Run-a-simulation"><a class="docs-heading-anchor" href="#Run-a-simulation">Run a simulation</a><a id="Run-a-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-a-simulation" title="Permalink"></a></h3><p>To run a simulation, we pass in the output and rulset.</p><pre><code class="language-julia">sim!(output, ruleset);</code></pre><h3 id="Save-a-gif-of-your-simulation"><a class="docs-heading-anchor" href="#Save-a-gif-of-your-simulation">Save a gif of your simulation</a><a id="Save-a-gif-of-your-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Save-a-gif-of-your-simulation" title="Permalink"></a></h3><p>Gif files are an easy way to share the visual dynamics of the simulation. First we need to define a color processor to turn the simulation into images for the frames of the the gif. This processor can also be used later in web or gtk outputs.</p><p>You can use the built-in <code>Greyscale</code> scheme, or any scheme from <a href="https://github.com/JuliaGraphics/ColorSchemes.jl">ColorSchemes.jl</a>.</p><pre><code class="language-julia">using ColorSchemes, Colors
scheme = ColorSchemes.Oranges_3
#scheme = ColorSchemes.autumn1

## Frame Processing Colors
zerocolor = RGB24(0.7)
maskcolor = RGB24(0.0)
textconfig = TextConfig(font=&quot;arial&quot;)
processor = ColorProcessor(scheme, zerocolor, maskcolor, textconfig);</code></pre><p>With a non-image output like ArrayOuput we need to pass in the image processor manually.</p><pre><code class="language-julia">savegif(joinpath(basedir, &quot;build/assets/sim.gif&quot;), output; minval=0.0, maxval=1e7, processor=processor, fps=10);</code></pre><p><img src="assets/sim.gif" alt="Drosphila suzukii spread"/></p><h2 id="Live-simulation-outputs"><a class="docs-heading-anchor" href="#Live-simulation-outputs">Live simulation outputs</a><a id="Live-simulation-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Live-simulation-outputs" title="Permalink"></a></h2><p>There are a number of live outputs provided in CelularAutomataBase.jl and specific output packages DynamicGridsGtk and DynamicGridsInteract that keep heavy graphics and web dependencies separate form the rest of the framework.</p><h3 id="REPL-output"><a class="docs-heading-anchor" href="#REPL-output">REPL output</a><a id="REPL-output-1"></a><a class="docs-heading-anchor-permalink" href="#REPL-output" title="Permalink"></a></h3><p>You can view a simulation over SSH or just in your local console using the included <code>REPLOutput</code>. It doesn&#39;t work so well in Atom/Juno, so we only recommend using it in a real terminal. It also works better in a terminal where you can easily reduce the font size.</p><pre><code class="language-julia">using Crayons
output = REPLOutput(init; tspan=tspan, style=Block(), fps=5, color=:white, store=false)
sim!(output, ruleset);</code></pre><p>The <code>Braile()</code> style is half the dimensions of the <code>Block()</code> style, but doen&#39;t look as clear.</p><pre><code class="language-julia">output = REPLOutput(init; tspan=tspan, style=Braile(), fps=5, color=:white, store=false)
sim!(output, ruleset);</code></pre><h3 id="Interactive-web-outputs"><a class="docs-heading-anchor" href="#Interactive-web-outputs">Interactive web outputs</a><a id="Interactive-web-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Interactive-web-outputs" title="Permalink"></a></h3><p><a href="http://gihub.com/rafaqz/DynamicGridsInteract.jl">DynamicGridsInteract.jl</a> produces interactive web page outputs for a simulation. It uses Interact.jl for live control, providing a control console and sliders for model parameters, even for your own custom models.</p><p>The simple <code>InteractOutput()</code> is the core output that can run on its own inside Juno or a Jupyter notebook. It can also be served to a browser locally or over the web using <code>ServerOutput()</code>, or run in a standalone desktop app using <code>ElectronOutput()</code>.</p><h3 id="Juno-or-jupyter-notebooks"><a class="docs-heading-anchor" href="#Juno-or-jupyter-notebooks">Juno or jupyter notebooks</a><a id="Juno-or-jupyter-notebooks-1"></a><a class="docs-heading-anchor-permalink" href="#Juno-or-jupyter-notebooks" title="Permalink"></a></h3><p>Building a <code>InteractOutput()</code> and running <code>display()</code> will open an output in a plot pane in Juno. See the example above to define an image processor. Setting <code>store</code> to true will save the last simulation to the output array to be saved or converted to a gif. Really long simulations may use your avilable ram, in which case set <code>store</code> to false.</p><pre><code class="language-julia">using DynamicGridsInteract
output = InteractOutput(init, ruleset;
    ruleset=ruleset,
    tspan=tspan,
    fps=10,
    store=true,
    processor=processor,
    slider_throttle=1.0,
)
display(output)</code></pre><h3 id="Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app"><a class="docs-heading-anchor" href="#Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app">Wrap the IneractOutput in a standalone desktop (electron) app</a><a id="Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app-1"></a><a class="docs-heading-anchor-permalink" href="#Wrap-the-IneractOutput-in-a-standalone-desktop-(electron)-app" title="Permalink"></a></h3><p>This will create a standalone desktop app wrapping the InteractOutput. Unfortunately the compile and load time for electron can take quite a while.</p><pre><code class="language-julia">output = ElectronOutput(init;
    ruleset=ruleset,
    tspan=tspan,
    fps=10,
    store=true,
    processor=processor,
    slider_throttle=1.0,
)</code></pre><h3 id="Serving-web-pages"><a class="docs-heading-anchor" href="#Serving-web-pages">Serving web pages</a><a id="Serving-web-pages-1"></a><a class="docs-heading-anchor-permalink" href="#Serving-web-pages" title="Permalink"></a></h3><p>The <code>InteractOutput</code> can be served locally or over the web. You may need to do some port or firewall configuration on your server, but otherwise this is all you need to do to serve a simulation. Unlike other outputs, <code>ServerOutput</code> makes a copy of the internal <code>InteractOutput</code> for each new connection. Changes in one connection will not effect anything in the others.</p><pre><code class="language-julia">output = ServerOutput(init;
    ruleset=ruleset,
    tspan=tspan,
    fps=10,
    processor=processor,
    slider_throttle=1.0,
    port=8080,
)</code></pre><p>If run locally, the interface should be served at the address &quot;localhost:8080&quot; in your web browser.</p><h3 id="Run-in-a-GTK-window"><a class="docs-heading-anchor" href="#Run-in-a-GTK-window">Run in a GTK window</a><a id="Run-in-a-GTK-window-1"></a><a class="docs-heading-anchor-permalink" href="#Run-in-a-GTK-window" title="Permalink"></a></h3><p>The <code>GTKOutput</code> in <a href="http://gihub.com/rafaqz/DynamicGridsGtk.jl">DynamicGridsGtk.jl</a> is a simple desktop output that just shows the simulation without controls. It can be useful for faster load-time than <code>ElectronOutput</code>, and also dedicates all screenspace to viewing the simulation.</p><pre><code class="language-julia">using DynamicGridsGtk
output = GtkOutput(init .* 0;
    mask=masklayer,
    tspan=tspan,
    fps=10,
    store=true,
    processor=processor
)
sim!(output, ruleset)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 17 February 2021 02:23">Wednesday 17 February 2021</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
